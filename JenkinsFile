pipeline {
    agent any

    environment {
        IMAGE_NAME = "samanth237/my-springboot-app"
        CONTAINER_NAME = "springboot-app"
        EC2_USER = "ec2-user"  // Change based on your AMI (Ubuntu: ubuntu, Amazon Linux: ec2-user)
        EC2_HOST = "13.201.103.187"  // Replace with your EC2 Public IP
        SSH_KEY = "/Users/samanthgoud/Downloads/sshdemo/demo.pem"  // Private key for SSH access
    }

    stages {
        stage('Clone Repository') {
            steps {
                git 'https://github.com/Samanth237/my-springboot-app.git'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh "docker build -t $IMAGE_NAME ."
                }
            }
        }

       
        stage('Push to Docker Hub') {
            steps {
                script {
                    withDockerRegistry([credentialsId: 'docker-hub-credentials', url: 'https://index.docker.io/v1/']) {
                        sh "docker push $IMAGE_NAME"
                    }
                }
            }
        }
        


        stage('Deploy to EC2') {
            steps {
                script {
                    sh """
                        ssh -i $SSH_KEY $EC2_USER@$EC2_HOST << 'EOF'
                        docker pull $IMAGE_NAME
                        docker stop $CONTAINER_NAME || true
                        docker rm $CONTAINER_NAME || true
                        docker run -d --name $CONTAINER_NAME -p 8080:8080 $IMAGE_NAME
                        EOF
                    """
                }
            }
        }
    }
}
